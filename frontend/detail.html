<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LizardMatch - ì¢… ìƒì„¸ ì •ë³´</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¦ LizardMatch</h1>
            <p class="subtitle">íŒŒì¶©ë¥˜/ì–‘ì„œë¥˜ ì¢… ì¶”ì²œ ì„œë¹„ìŠ¤</p>
        </header>

        <main class="detail-container">
            <div id="loadingMessage" class="loading-message">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="detailContent" class="detail-content">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>

            <div class="form-actions">
                <button type="button" id="backBtn" class="btn btn-secondary">ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const speciesName = urlParams.get('species');
            
            if (!speciesName) {
                document.getElementById('errorMessage').textContent = 'ì¢… ì´ë¦„ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loadingMessage').style.display = 'none';
                return;
            }

            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/species/${encodeURIComponent(speciesName)}`);
                
                if (!response.ok) {
                    throw new Error('ì¢… ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const species = await response.json();
                displaySpeciesDetail(species);
            } catch (e) {
                console.error('ì˜¤ë¥˜:', e);
                document.getElementById('errorMessage').textContent = 'ì¢… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        });

        function isEmpty(value) {
            return value === null || value === undefined || value === '';
        }

        function parseHumidityRange(rangeStr) {
            if (!rangeStr) return null;
            const nums = (rangeStr.match(/\d+/g) || []).map(n => parseInt(n, 10)).filter(n => !isNaN(n));
            if (nums.length === 0) return null;
            let min = Math.min(...nums);
            let max = Math.max(...nums);
            return { min, max };
        }

        function buildFailureTips(species) {
            const tips = [];

            // ê³¼ìŠµ ìœ„í—˜
            const humRange = parseHumidityRange(species.ìŠµë„_ë²”ìœ„);
            if (humRange && humRange.max >= 80) {
                tips.push({
                    title: 'ê³¼ìŠµ/ê³°íŒ¡ì´ ì£¼ì˜',
                    desc: 'ìŠµë„ê°€ ë†’ì€ ì¢…ì´ë¼ í™˜ê¸°ì™€ ë°”ë‹¥ì¬ ê´€ë¦¬ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤. í™˜ê¸° êµ¬ë©ê³¼ ì œìŠµ í™˜ê²½ì„ í•¨ê»˜ ê³ ë ¤í•´ì£¼ì„¸ìš”.'
                });
            }

            // ê±´ì¡° ìœ„í—˜
            if (humRange && humRange.min <= 40) {
                tips.push({
                    title: 'ê±´ì¡°/íƒˆí”¼ ì‹¤íŒ¨ ì£¼ì˜',
                    desc: 'ìŠµë„ê°€ ë‚®ìœ¼ë©´ íƒˆí”¼ ì‹¤íŒ¨ë‚˜ í”¼ë¶€ ê±´ì¡°ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì€ì‹ ì²˜ì™€ ë¶€ë¶„ ê°€ìŠµ(ë¶„ë¬´/ìŠµì€ì‹ ì²˜)ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.'
                });
            }

            // ì˜¨ìŠµë„ ë‚œì´ë„ ë†’ìŒ
            if (species.ì˜¨ë„ìŠµë„_5ë‹¨ê³„ && Number(species.ì˜¨ë„ìŠµë„_5ë‹¨ê³„) >= 4) {
                tips.push({
                    title: 'ì„¸íŒ… ë‚œì´ë„ ë†’ìŒ',
                    desc: 'ì˜¨ë„/ìŠµë„ ê´€ë¦¬ê°€ ê¹Œë‹¤ë¡œìš´ ì¢…ì…ë‹ˆë‹¤. ì˜¨ìŠµë„ê³„, ì„œëª¨ìŠ¤íƒ¯, íƒ€ì´ë¨¸ ë“± ìë™í™” ì¥ë¹„ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'
                });
            }

            // í•¸ë“¤ë§ ìŠ¤íŠ¸ë ˆìŠ¤
            if (species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„ && Number(species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„) <= 2) {
                tips.push({
                    title: 'í•¸ë“¤ë§ ìµœì†Œí™” ê¶Œì¥',
                    desc: 'ì†ì„ ë§ì´ íƒ€ì§€ ì•ŠëŠ” ì¢…ì´ë¼ ì¦ì€ í•¸ë“¤ë§ì€ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê´€ìƒ ìœ„ì£¼ë¡œ ê°ìƒí•´ ì£¼ì„¸ìš”.'
                });
            }

            return tips;
        }

        function displaySpeciesDetail(species) {
            const detailContent = document.getElementById('detailContent');
            
            let html = '<div class="species-detail">';

            // A. í—¤ë” ì˜ì—­
            html += '<section class="detail-section header-section">';
            html += `<h2>${species.ì¢…_í•œê¸€ëª… || 'ì´ë¦„ ì—†ìŒ'}</h2>`;
            if (species.ì‚¬ì§„_URL) {
                const imageUrl = convertWikipediaImageUrl(species.ì‚¬ì§„_URL);
                html += `<img src="${imageUrl}" alt="${species.ì¢…_í•œê¸€ëª…}" onerror="handleImageError(this)" class="species-image">`;
            }
            html += '<div class="badge-row">';
            if (!isEmpty(species.ì¢…ë¥˜)) {
                html += `<span class="badge badge-type">${species.ì¢…ë¥˜}</span>`;
            }
            if (!isEmpty(species.ê´€ìƒìš©_ì• ì™„ìš©)) {
                html += `<span class="badge badge-purpose">${species.ê´€ìƒìš©_ì• ì™„ìš©}</span>`;
            }
            html += '</div>';
            html += '</section>';

            // B. í•µì‹¬ ìš”ì•½ ì¹´ë“œ (5ì§€í‘œ)
            html += '<section class="detail-section summary-section">';
            html += '<h3>í•µì‹¬ ìš”ì•½</h3>';
            html += '<div class="summary-grid">';
            html += `<div class="summary-item"><span class="label">ì‚¬ìœ¡ ë‚œì´ë„</span><span class="value">${species.ì‚¬ìœ¡_ë‚œì´ë„_5ë‹¨ê³„ || '-'}/5</span></div>`;
            html += `<div class="summary-item"><span class="label">ì´ˆê¸° ë¹„ìš©</span><span class="value">${species.ì´ˆê¸°ë¹„ìš©_ë“±ê¸‰_5ë‹¨ê³„ || '-'}/5</span></div>`;
            html += `<div class="summary-item"><span class="label">í•¸ë“¤ë§ ì í•©ë„</span><span class="value">${species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„ || '-'}/5</span></div>`;
            html += `<div class="summary-item"><span class="label">ì„±ì²´ í¬ê¸°</span><span class="value">${species.ì„±ì²´í¬ê¸°_ë“±ê¸‰_3ë‹¨ê³„ || '-'}/3</span></div>`;
            html += `<div class="summary-item"><span class="label">ì‚¬ìœ¡ì¥ í¬ê¸°</span><span class="value">${species.ì‚¬ìœ¡ì¥_ì‚¬ì´ì¦ˆ_3ë‹¨ê³„ || '-'}/3</span></div>`;
            html += '</div>';
            html += '</section>';

            // C. ì‚¬ìœ¡ í™˜ê²½ ì¹´ë“œ
            const hasEnv =
                !isEmpty(species.ì˜¨ë„_ë²”ìœ„_ì£¼ê°„) ||
                !isEmpty(species.ì˜¨ë„_ë²”ìœ„_ì•¼ê°„) ||
                !isEmpty(species.ë°”ìŠ¤í‚¹_ì˜¨ë„) ||
                !isEmpty(species.ìŠµë„_ë²”ìœ„) ||
                !isEmpty(species.ì˜¨ë„ìŠµë„_5ë‹¨ê³„) ||
                !isEmpty(species.ì˜¨ìŠµë„_ì ê²€_ì£¼ê¸°);

            if (hasEnv) {
                html += '<section class="detail-section env-section">';
                html += '<h3>ì‚¬ìœ¡ í™˜ê²½</h3>';
                html += '<div class="detail-info">';
                if (!isEmpty(species.ì˜¨ë„_ë²”ìœ„_ì£¼ê°„)) {
                    html += `<p><strong>ì£¼ê°„ ì˜¨ë„:</strong> ${species.ì˜¨ë„_ë²”ìœ„_ì£¼ê°„}</p>`;
                }
                if (!isEmpty(species.ì˜¨ë„_ë²”ìœ„_ì•¼ê°„)) {
                    html += `<p><strong>ì•¼ê°„ ì˜¨ë„:</strong> ${species.ì˜¨ë„_ë²”ìœ„_ì•¼ê°„}</p>`;
                }
                if (!isEmpty(species.ë°”ìŠ¤í‚¹_ì˜¨ë„)) {
                    html += `<p><strong>ë°”ìŠ¤í‚¹ ì˜¨ë„:</strong> ${species.ë°”ìŠ¤í‚¹_ì˜¨ë„}</p>`;
                }
                if (!isEmpty(species.ìŠµë„_ë²”ìœ„)) {
                    html += `<p><strong>ìŠµë„ ë²”ìœ„:</strong> ${species.ìŠµë„_ë²”ìœ„}</p>`;
                }
                if (!isEmpty(species.ì˜¨ë„ìŠµë„_5ë‹¨ê³„)) {
                    html += `<p><strong>ì˜¨ìŠµë„ ë‚œì´ë„:</strong> ${species.ì˜¨ë„ìŠµë„_5ë‹¨ê³„}/5</p>`;
                }
                if (!isEmpty(species.ì˜¨ìŠµë„_ì ê²€_ì£¼ê¸°)) {
                    html += `<p><strong>ì˜¨ìŠµë„ ì ê²€ ì£¼ê¸°:</strong> ${species.ì˜¨ìŠµë„_ì ê²€_ì£¼ê¸°}</p>`;
                }
                html += '</div>';
                html += '</section>';
            }

            // D. ì¼€ì–´ ë£¨í‹´ ì¹´ë“œ
            const hasRoutine =
                !isEmpty(species.ê¸‰ì—¬_ì£¼ê¸°) ||
                !isEmpty(species.ê¸‰ì—¬_êµ¬ì„±) ||
                !isEmpty(species.ë¨¹ì´ë¹ˆë„_ë“±ê¸‰) ||
                !isEmpty(species.ë¬¼_ê¸‰ì—¬) ||
                !isEmpty(species.ë¶„ë¬´_ì£¼ê¸°) ||
                !isEmpty(species.ì²­ì†Œ_ì£¼ê¸°);

            if (hasRoutine) {
                html += '<section class="detail-section routine-section">';
                html += '<h3>ì¼€ì–´ ë£¨í‹´</h3>';
                html += '<div class="detail-info">';
                if (!isEmpty(species.ê¸‰ì—¬_ì£¼ê¸°)) {
                    html += `<p><strong>ê¸‰ì—¬ ì£¼ê¸°:</strong> ${species.ê¸‰ì—¬_ì£¼ê¸°}</p>`;
                }
                if (!isEmpty(species.ê¸‰ì—¬_êµ¬ì„±)) {
                    html += `<p><strong>ê¸‰ì—¬ êµ¬ì„±:</strong> ${species.ê¸‰ì—¬_êµ¬ì„±}</p>`;
                }
                if (!isEmpty(species.ë¨¹ì´ë¹ˆë„_ë“±ê¸‰)) {
                    html += `<p><strong>ë¨¹ì´ ë¹ˆë„ ë“±ê¸‰:</strong> ${species.ë¨¹ì´ë¹ˆë„_ë“±ê¸‰}</p>`;
                }
                if (!isEmpty(species.ë¬¼_ê¸‰ì—¬)) {
                    html += `<p><strong>ë¬¼ ê¸‰ì—¬ ë°©ì‹:</strong> ${species.ë¬¼_ê¸‰ì—¬}</p>`;
                }
                if (!isEmpty(species.ë¶„ë¬´_ì£¼ê¸°)) {
                    html += `<p><strong>ë¶„ë¬´ ì£¼ê¸°:</strong> ${species.ë¶„ë¬´_ì£¼ê¸°}</p>`;
                }
                if (!isEmpty(species.ì²­ì†Œ_ì£¼ê¸°)) {
                    html += `<p><strong>ì²­ì†Œ ì£¼ê¸°:</strong> ${species.ì²­ì†Œ_ì£¼ê¸°}</p>`;
                }
                html += '</div>';
                html += '</section>';
            }

            // E. ë¨¹ì´/ì‹ì„± ì¹´ë“œ
            const hasDiet = !isEmpty(species.ì‹ì„±íƒ€ì…) || !isEmpty(species.ê¸‰ì—¬_êµ¬ì„±);
            if (hasDiet) {
                html += '<section class="detail-section diet-section">';
                html += '<h3>ë¨¹ì´ / ì‹ì„±</h3>';
                html += '<div class="detail-info">';
                if (!isEmpty(species.ì‹ì„±íƒ€ì…)) {
                    html += `<p><strong>ì‹ì„± íƒ€ì…:</strong> ${species.ì‹ì„±íƒ€ì…}</p>`;
                }
                if (!isEmpty(species.ê¸‰ì—¬_êµ¬ì„±)) {
                    html += `<p><strong>ê¸‰ì—¬ êµ¬ì„±:</strong> ${species.ê¸‰ì—¬_êµ¬ì„±}</p>`;
                }
                html += '</div>';
                html += '</section>';
            }

            // F. ì„±í–¥/í™œë™ ì¹´ë“œ
            const hasBehavior =
                !isEmpty(species.í™œë™íŒ¨í„´) ||
                !isEmpty(species.ì™¸í˜•íƒœê·¸) ||
                !isEmpty(species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„);

            if (hasBehavior) {
                html += '<section class="detail-section behavior-section">';
                html += '<h3>ì„±í–¥ / í™œë™</h3>';
                html += '<div class="detail-info">';
                if (!isEmpty(species.í™œë™íŒ¨í„´)) {
                    html += `<p><strong>í™œë™ íŒ¨í„´:</strong> ${species.í™œë™íŒ¨í„´}</p>`;
                }
                if (!isEmpty(species.ì™¸í˜•íƒœê·¸)) {
                    html += `<p><strong>ì™¸í˜• íƒœê·¸:</strong> ${species.ì™¸í˜•íƒœê·¸}</p>`;
                }
                if (!isEmpty(species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„)) {
                    html += `<p><strong>í•¸ë“¤ë§ ì í•©ë„:</strong> ${species.í•¸ë“¤ë§ì í•©ë„_5ë‹¨ê³„}/5</p>`;
                }
                html += '</div>';
                html += '</section>';
            }

            // G. ë²•/ì£¼ì˜ + ì‹¤íŒ¨ í¬ì¸íŠ¸ & í•´ê²° íŒ
            const tips = buildFailureTips(species);
            const hasLawOrTips = !isEmpty(species.CITES_ë“±ì¬_ì—¬ë¶€) || tips.length > 0;
            if (hasLawOrTips) {
                html += '<section class="detail-section law-section">';
                html += '<h3>ë²• / ì£¼ì˜ ì‚¬í•­</h3>';
                if (!isEmpty(species.CITES_ë“±ì¬_ì—¬ë¶€)) {
                    html += `<p><strong>CITES ë“±ì¬ ì—¬ë¶€:</strong> ${species.CITES_ë“±ì¬_ì—¬ë¶€}</p>`;
                }
                if (tips.length > 0) {
                    html += '<div class="failure-tips">';
                    html += '<h4>í”í•œ ì‹¤íŒ¨ í¬ì¸íŠ¸ & í•´ê²° íŒ</h4>';
                    html += '<ul>';
                    tips.forEach(t => {
                        html += `<li><strong>${t.title}</strong> - ${t.desc}</li>`;
                    });
                    html += '</ul>';
                    html += '</div>';
                }
                html += '</section>';
            }

            // H. êµ¬ë§¤/ì°¸ê³  ë§í¬ ì¹´ë“œ
            if (!isEmpty(species.êµ¬ë§¤_ê°€ëŠ¥_ì „ë¬¸ìƒµ_ë§í¬)) {
                html += '<section class="detail-section shop-section">';
                html += '<h3>êµ¬ë§¤/ì°¸ê³  ë§í¬</h3>';
                html += `<p><a href="${species.êµ¬ë§¤_ê°€ëŠ¥_ì „ë¬¸ìƒµ_ë§í¬}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">ì „ë¬¸ ìƒµì—ì„œ ìì„¸íˆ ë³´ê¸°</a></p>`;
                html += '</section>';
            }

            // I. ë°ì´í„° ì‹ ë¢°/ì—…ë°ì´íŠ¸ ì¹´ë“œ
            const hasMeta =
                !isEmpty(species.ì¶”ì¶œ_ì‹ ë¢°ë„_ì ìˆ˜) ||
                !isEmpty(species.ìµœì¢…_ê²€ìˆ˜_ìƒíƒœ) ||
                !isEmpty(species.ìµœì¢…_ê°±ì‹ ì¼);

            if (hasMeta) {
                html += '<section class="detail-section meta-section">';
                html += '<h3>ë°ì´í„° ì‹ ë¢° / ì—…ë°ì´íŠ¸</h3>';
                html += '<div class="detail-info">';
                if (!isEmpty(species.ì¶”ì¶œ_ì‹ ë¢°ë„_ì ìˆ˜)) {
                    html += `<p><strong>ì¶”ì¶œ ì‹ ë¢°ë„ ì ìˆ˜:</strong> ${species.ì¶”ì¶œ_ì‹ ë¢°ë„_ì ìˆ˜}</p>`;
                }
                if (!isEmpty(species.ìµœì¢…_ê²€ìˆ˜_ìƒíƒœ)) {
                    html += `<p><strong>ìµœì¢… ê²€ìˆ˜ ìƒíƒœ:</strong> ${species.ìµœì¢…_ê²€ìˆ˜_ìƒíƒœ}</p>`;
                }
                if (!isEmpty(species.ìµœì¢…_ê°±ì‹ ì¼)) {
                    html += `<p><strong>ìµœì¢… ê°±ì‹ ì¼:</strong> ${species.ìµœì¢…_ê°±ì‹ ì¼}</p>`;
                }
                html += '</div>';
                html += '</section>';
            }

            html += '</div>'; // species-detail
            
            detailContent.innerHTML = html;
        }

        // ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
        document.getElementById('backBtn').addEventListener('click', () => {
            window.history.back();
        });
    </script>
</body>
</html>

