## LizardMatch 추천 서비스 기능 정리 (서버 기능 제외)

이 문서는 `도마뱀 주인 찾기 서비스` 프로젝트 내 **추천 서비스의 기능**을 정리한 것입니다.  
배포·서버 인프라 등은 제외하고, **설문 흐름, 사용된 AI(추천 로직), 결과 화면, 세부 보기 화면의 기능**만을 설명합니다.

---

## 1. 설문 방식 (4단계 설문 플로우)

- **전체 구조**
  - 설문 페이지: `index.html` → `survey_page2.html` → `survey_page3.html` → `survey_page4.html`
  - 각 페이지의 입력값은 `sessionStorage`에 `page1`~`page4` 키로 저장됩니다.  
    (`frontend/survey_navigation.js` 의 `saveCurrentPageData`, `restoreCurrentPageData`, `collectAllPageData` 참고)
  - 페이지 이동 시에도 입력값이 유지되고, 마지막 페이지에서 모든 페이지의 데이터를 합쳐 추천 API를 호출합니다.

- **페이지별 역할**
  - **1단계 (`index.html`) – 기본 선호 종/중요도 선택**
    - 사용자가 관심 있는 **종류(도마뱀/거북/개구리/카멜레온/뱀 등)**을 체크박스로 선택.
    - 각 종류별 **중요도(가중치)**를 선택하는 인터페이스 존재.
    - 선택한 종류/중요도를 기반으로 추천 시 **종류 필터 및 가중치**에 반영.
    - 페이지 하단에 다음 단계로 이동 버튼, 진행도 표시(1/4).
  - **2단계 (`survey_page2.html`) – 사육 난이도·초기 비용·사육장 크기·먹이 부담**
    - **사육 난이도(5단계)**: 초보/중급/고급 수준을 선택.
    - **초기 비용 예산(1~5단계)**:  
      - “10만원 이하” ~ “100만원 이상” 등 구간별로 구체적인 예산 설명이 안내 문구로 포함.
    - **사육장 크기(3단계)**: 소형/중형/대형 등, 실제 설치 공간 감각에 대한 설명과 함께 제시.
    - **먹이 부담(급여 빈도)**:  
      - 자주 급여해야 하는 종 vs. 주 1회 정도 급여하는 종 등, **현실적인 돌봄 빈도**를 텍스트로 설명.
    - 각 항목은 “얼마나 중요한지(중요도 슬라이더/선택)”와 함께 구성되어, 뒤의 가중치로 활용.
  - **3단계 (`survey_page3.html`) – 사육 목적·식성 타입·외형 태그**
    - **사육 목적**: 관상용 / 애완용 / 둘 다 중 선택.
    - **식성 타입**: 육식 / 초식 / 잡식 등 선호.
    - **외형 태그(체형/무늬/색감 등)**:  
      - “멋있다”, “작다”, “알록달록하다” 등 여러 태그를 복수 선택 가능.
    - 활동 패턴(주행성/야행성) 등도 함께 선택하여, 생활 리듬과 맞는 종을 고를 수 있도록 설계.
  - **4단계 (`survey_page4.html`) – 최종 확인 및 추천 요청**
    - 앞선 1~3단계에서 입력한 정보가 모두 `collectAllPageData()` 로 합쳐짐.
    - “추천 받기” 버튼 클릭 시:
      - 버튼 비활성화 + “처리 중...” 텍스트로 변경.
      - `loadingMessage` 표시로 로딩 상태 안내.
      - 백엔드 추천 API (`/api/recommend`) 호출.
      - 응답 받은 결과를 `sessionStorage.recommendationResults` 에 저장 후 `results.html` 로 이동.

- **데이터 저장 및 복원**
  - 각 페이지에서 `saveCurrentPageData()` 가 호출되어 현재 폼 내용을 **자동 저장**.
  - 페이지 재진입 시 `restoreCurrentPageData()` 가 실행되어 **입력값을 다시 폼에 채워 넣음**.
  - 체크박스(특히 `종류`, `외형태그`)는 복수 선택을 지원하고, 배열로 관리됩니다.

---

## 2. 사용한 AI / 추천 로직

- **전반 개요**
  - 추천 엔진은 **머신러닝 모델 대신, 규칙 기반 + 가중치 기반 스코어링 로직**으로 구현.
  - 구현 파일:
    - 추천 엔진 본체: `backend/recommendation_engine.py`
    - 세부 점수 계산 헬퍼: `backend/scoring_helpers.py`
  - CSV 데이터(종별_수집정보_가독성개선_최종.csv)를 판다스로 로드한 뒤, 각 종에 대해 **0~100점 사이의 매칭 점수(match_score)**를 계산하고 상위 N개(기본 10개)를 추천 결과로 반환.

- **핵심 개념: ScoringContext**
  - `ScoringContext` 클래스는 각 종에 대한 점수 계산 과정에서:
    - **질문별 가중치(custom_weights)** 관리
    - **질문별 기여도(question_contributions)** 누적
    - **추천 근거(match_reasons)** 문장 저장
  - 이 정보는 최종적으로 결과 카드에서 **“추천 근거”와 “질문별 기여도”**를 보여줄 때 사용됩니다.

- **가중치(WEIGHTS)**
  - 기본 가중치 (`WEIGHTS`) 예시:
    - 사육 난이도: 20
    - 초기 비용: 15
    - 온·습도 난이도: 10
    - 활동 패턴: 10
    - 식성 타입: 5
    - 먹이 빈도: 10
    - 핸들링 적합도: 10
    - 사육장 크기: 10
    - 성체 크기: 5
    - 외형 태그: 5
    - 관상용/애완용: 10
  - 사용자가 설문에서 특정 항목의 **중요도**를 높게 선택하면, `custom_weights` 로 반영 가능하도록 설계되어 있음.

- **점수 계산 흐름 (calculate_match_score)**
  1. **종류 필터 (하드 필터)**
     - `calculate_species_type_score` 에서 사용자 선택 종류 목록에 포함되지 않으면 **바로 0점** 처리 → 추천 목록에서 제외.
  2. **사육 난이도**
     - 종의 난이도 vs 사용자가 선택한 선호 난이도의 차이에 따라 100~25% 사이 점수.
     - 더 쉬운 종은 가산점, 훨씬 어려운 종은 점수 크게 감소.
  3. **초기 비용**
     - 종의 초기 비용 등급이 사용자 예산 이하이면 100점, 1단계 초과 시 33점, 더 크면 0점.
  4. **온·습도 난이도**
     - 난이도가 낮을수록 점수가 높게(1→100, 5→20) 계산.
  5. **활동 패턴**
     - 사용자가 선호한 패턴(주행성/야행성)과 일치하면 100점, 아니면 0점.
  6. **식성 타입**
     - 선호 식성과 동일하면 100점, 아니면 0점.
  7. **먹이 빈도**
     - 사용자가 “이 정도까지는 괜찮다”고 선택한 빈도 이하이면 100점.
     - 1단계 높은 경우 50점, 그 이상은 25점.
  8. **핸들링 적합도**
     - 선호 등급 이상이면 100점, 1단계 낮으면 50점, 훨씬 낮으면 25점.
  9. **사육장 크기**
     - 선호 최대 크기 이하이면 100점, 초과하면 0점.
  10. **성체 크기**
      - 작을수록 점수가 높게(1→100, 3→0) 계산.
  11. **외형 태그**
      - 사용자 선택 외형 태그 목록과 종의 태그가 얼마나 겹치는지에 따라 비율 스코어(0~100) → 가중치 적용.
  12. **관상용/애완용**
      - 선호 목적과 동일하면 100점.
      - 종이 “둘 다”이면 어느 쪽이든 80점.

- **최종 점수 산출**
  - 위 항목들의 기여도 합을 **전체 가중치 합으로 나누어 0~100 범위로 정규화**.
  - `recommend()` 함수가 각 종에 대해 `match_score` 와 함께:
    - 종 기본 정보(이름, 종류, 관상용/애완용, 사진 URL 등)
    - 초기 비용 등급
    - 계산된 월 유지비 등급(내부적으로는 계산하지만, 결과 화면에서는 표시 제외)
    - 한 줄 사육 요약 (`generate_care_summary`)  
    - 상위 추천 근거 2개, 질문별 기여도 상위 5개  
    를 묶어서 반환합니다.

---

## 3. 자세히 보기(detail.html)의 모든 기능

- **기본 구조**
  - URL 예: `detail.html?species=레오파드 게코`
  - 쿼리스트링에서 `species` 값을 읽어 해당 종의 상세 정보를 API로 가져옵니다.
  - 사용 API: `/api/species/<species_name>`
  - 로딩 중 표시, 에러 메시지 표시, “결과로 돌아가기” 버튼을 통해 UX 를 지원.

- **데이터 로드 흐름**
  1. `DOMContentLoaded` 시점에 URL 파라미터에서 `species` 추출.
  2. 값이 없으면 에러 메시지: “종 이름이 제공되지 않았습니다.”
  3. 값이 있으면:
     - `getApiBaseUrl()`로 백엔드 주소 결정.
     - `/api/species/<encodeURIComponent(speciesName)>` 로 fetch.
     - 성공 시 JSON 응답을 `displaySpeciesDetail(species)` 에 전달.
     - 실패 시 “종 정보를 불러올 수 없습니다.” 메시지 표시.

- **공통 유틸 기능**
  - `isEmpty(value)`  
    - `null`, `undefined`, 빈 문자열인 경우를 통합적으로 “없음”으로 처리.
  - `parseHumidityRange(rangeStr)`  
    - “40~60%” 같은 문자열에서 숫자만 추출해 최소/최대 습도 범위를 계산.
  - `buildFailureTips(species)`  
    - 종 데이터 기반으로 **흔한 실패 포인트 + 해결 팁**을 자동 생성:
      - 습도 상한이 80% 이상인 경우: 과습/곰팡이 주의.
      - 습도 하한이 40% 이하인 경우: 건조/탈피 실패 주의.
      - 온습도 난이도(온도습도_5단계)가 4 이상: 세팅 난이도 높음.
      - 핸들링 적합도(핸들링적합도_5단계)가 2 이하: 핸들링 최소화 권장.

- **섹션별 상세 기능 (displaySpeciesDetail)**
  - **A. 헤더 영역**
    - 종 한글명 제목.
    - 대표 이미지(있다면):
      - `convertWikipediaImageUrl` 로 위키미디어/위키피디아 URL을 직접 표시 가능한 이미지 URL로 변환.
      - 실패 시 `handleImageError` 로 “이미지 없음” SVG 플레이스홀더 표시.
    - 배지(badge):
      - `종류` 배지 (예: “게코”, “도마뱀” 등).
      - `관상용_애완용` 배지 (“관상용”, “애완용”, “둘 다”).
  - **B. 핵심 요약 카드**
    - 5개 핵심 지표를 카드 형태로 한눈에 보여줌:
      - 사육 난이도 (1~5)
      - 초기 비용 등급 (1~5)
      - 핸들링 적합도 (1~5)
      - 성체 크기 등급 (1~3)
      - 사육장 크기 등급 (1~3)
    - 각 항목은 “레이블 + /5 또는 /3 형식 값”으로 정리.
  - **C. 사육 환경(온도/습도) 카드**
    - 아래 정보 중 실제 데이터가 있는 것만 선택적으로 노출:
      - 주간 온도 범위
      - 야간 온도 범위
      - 바스킹 온도
      - 습도 범위
      - 온습도 난이도(1~5)
      - 온습도 점검 주기
  - **D. 케어 루틴 카드**
    - 급여 주기 (예: 일 1회, 주 2~3회 등)
    - 급여 구성 (귀뚜라미/밀웜/채소 등)
    - 먹이 빈도 등급
    - 물 급여 방식 (물그릇/분무 등)
    - 분무 주기
    - 청소 주기
  - **E. 먹이/식성 카드**
    - 식성 타입(육식/초식/잡식 등)
    - 급여 구성(중복 표기도 허용, 정보 통합용)
  - **F. 성향/활동 카드**
    - 활동 패턴 (주행성/야행성)
    - 외형 태그 (귀엽다, 멋있다 등)
    - 핸들링 적합도(1~5)
  - **G. 법/주의 사항 + 실패 포인트 & 해결 팁**
    - CITES 등재 여부.
    - `buildFailureTips` 로 생성된 항목을 리스트로 표시:
      - “과습/곰팡이 주의”, “건조/탈피 실패 주의”, “세팅 난이도 높음”, “핸들링 최소화 권장” 등.
  - **H. 구매/참고 링크 카드**
    - `구매_가능_전문샵_링크` 가 있을 경우:
      - 새 창으로 여는 “전문 샵에서 자세히 보기” 버튼 노출.
  - **I. 데이터 신뢰/업데이트 카드**
    - 추출 신뢰도 점수.
    - 최종 검수 상태.
    - 최종 갱신일.

- **네비게이션**
  - 하단 “결과로 돌아가기” 버튼:
    - `window.history.back()` 으로 바로 이전 페이지(대부분 `results.html`)로 이동.

---

## 4. 결과창(results.html)의 모든 기능

- **기본 구조**
  - 설문 제출 후 이동하는 추천 결과 페이지.
  - 상단에 서비스 타이틀/부제목, 가운데에 추천 카드 목록, 하단에 “설문 다시하기” 버튼.

- **결과 데이터 로드 방식**
  - `DOMContentLoaded` 시점에 다음 순서로 결과를 찾습니다.
    1. URL 파라미터 `?results=` 가 있으면:
       - `decodeURIComponent` 후 JSON 파싱 시도.
       - 성공 시 `displayResults(results)` 호출.
    2. 그렇지 않으면 `sessionStorage.recommendationResults` 확인:
       - 존재하면 JSON 파싱 후 `displayResults(results)` 호출.
       - 없으면 “결과를 찾을 수 없습니다.” 에러 메시지 표시.
  - 현재 설계에서는 **URI Too Long 방지**를 위해, 실제 사용은 주로 **`sessionStorage` 기반**입니다.

- **결과 표시 기능 (displayResults)**
  - **기본 처리**
    - 로딩 메시지 숨김.
    - 결과가 없거나 빈 배열인 경우: “추천 결과가 없습니다.” 에러 메시지.
  - **헤더**
    - “추천 결과 (N개)” 형태로 추천 개수 표시.
  - **각 결과 카드 구성**
    - **순위**: 1, 2, 3 … 으로 추천 순위를 크게 표시.
    - **이미지**
      - `사진_URL` 존재 시:
        - `convertWikipediaImageUrl` 호출로 위키미디어 URL 보정.
        - 로드 실패 시 `handleImageError` 로 “이미지 없음” SVG 표시.
      - 없으면 텍스트 기반 이미지 플레이스홀더.
    - **기본 정보**
      - 종 한글명 (클릭 시 `detail.html?species=...` 로 이동하는 링크).
      - 종류(게코, 도마뱀 등).
      - 매칭 점수: `match_score` 를 굵게 표시 (예: `매칭 점수: 87.5점`).
    - **비용 정보**
      - **초기 비용**: `초기비용_등급_5단계` 값을 `formatCurrency` 로 원화 범위 텍스트(“10만원 이하”, “30~50만원” 등)로 변환하여 표시.
      - **월 유지비 등급은 결과 카드에서 의도적으로 표시하지 않음** (요구사항에 따라 제외).
    - **사육 요약**
      - `사육_요약` 텍스트를 한 줄 설명으로 표시  
        (예: “초보자도 도전 가능한 난이도입니다. 야행성으로 밤 시간 활동이 활발합니다.”).
    - **추천 근거**
      - `match_reasons` 배열이 있을 경우:
        - “추천 근거” 제목과 함께 리스트로 1~2개의 이유를 표시.
        - 예: “사육 난이도가 선호하신 난이도와 일치합니다”, “초기 비용이 예산 범위 내입니다” 등.
    - **질문별 기여도**
      - `question_contributions` 가 있을 경우:
        - “질문별 기여도” 영역에 상위 5개 항목을  
          “사육 난이도: 12.3점” 형태로 표시.
    - **세부 정보 보기 버튼**
      - 카드 하단 `세부 정보 보기` 버튼:
        - 링크: `detail.html?species=<종_한글명>`  
        - 클릭 시 해당 종의 상세 페이지로 이동.

- **설문 다시하기 기능**
  - 하단 `설문 다시하기` 버튼 클릭 시:
    - `sessionStorage.clear()` 로 이전 설문/결과 데이터 초기화.
    - `index.html?reset=true` 로 이동하여:
      - 첫 페이지부터 설문을 다시 진행.
      - `reset=true` 플래그에 따라 `restoreCurrentPageData()` 가 이전 값을 복원하지 않도록 동작.

---

위 내용은 프로젝트 루트(`c:\Users\a8865\OneDrive\바탕 화면\도마뱀 주인 찾기 서비스\`) 내 현재 코드 기준으로 정리한 **추천 서비스 기능 명세**입니다.  
추후 설문 문항 추가나 추천 로직 변경 시, 이 문서를 함께 업데이트하면 전체 기능 구조를 한눈에 파악하는 데 도움이 됩니다.


